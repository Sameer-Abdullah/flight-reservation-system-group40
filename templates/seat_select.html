<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Select Seats</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --ink:#0a1f44; --muted:#64748b; --ring:#bfdbfe; --ok:#0ea5e9;
    --busy:#94a3b8; --held:#cbd5e1; --blocked:#1e293b;
    --first:#a855f7; --biz:#06b6d4; --econ:#10b981;
    --f-bg:#faf5ff; --b-bg:#ecfeff; --e-bg:#f0fdf4;
    --exit:#ef4444;
    --metal:#d1d5db; --metal-deep:#9ca3af; --shadow:rgba(10,31,68,.12);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    background:linear-gradient(135deg,#0ea5e9 0%,#38bdf8 100%);
    color:#111; min-height:100svh; display:flex; flex-direction:column;
    position:relative; overflow-x:hidden;
    padding-bottom:140px;
  }
  body::before{
    content:""; position:fixed; inset:0;
    background-image:
      radial-gradient(circle at 20% 50%, rgba(255,255,255,.08) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(255,255,255,.06) 0%, transparent 50%);
    animation:float 20s ease-in-out infinite; pointer-events:none;
  }
  @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}

  header{
    position:sticky; top:0; z-index:10;
    background:rgba(255,255,255,.95); backdrop-filter:blur(12px);
    border-bottom:1px solid rgba(0,0,0,.06); padding:20px 24px;
  }
  header h1{margin:0;font-size:24px;font-weight:700;
    background:linear-gradient(135deg,#0ea5e9,#06b6d4);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
  }

  .wrap{max-width:1100px;margin:30px auto;padding:0 20px;display:flex;flex-direction:column;align-items:center;gap:24px}

  .meta{
    display:flex; gap:24px; flex-wrap:wrap; align-items:center; color:#1e293b;
    background:rgba(255,255,255,.95); backdrop-filter:blur(12px);
    border:1px solid rgba(0,0,0,.08); border-radius:16px; padding:16px 20px; font-size:14px; font-weight:500;
  }
  #legend{display:flex; gap:12px; flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(0,0,0,.08);border-radius:999px;padding:6px 12px;font-size:13px;background:rgba(255,255,255,.8)}
  .sw{width:16px;height:16px;border-radius:4px;border:1.5px solid #e2e8f0}
  .sw.available{background:#fff}
  .sw.selected{background:var(--ok);border-color:var(--ok);box-shadow:0 0 0 2px rgba(14,165,233,.2)}
  .sw.busy{background:var(--busy);border-color:var(--busy)}
  .sw.held{background:var(--held);border-color:var(--held)}
  .sw.blocked{background:var(--blocked);border-color:var(--blocked)}
  .sw.exit{background:var(--exit);border-color:var(--exit)}

  .stage{width:100%;display:flex;justify-content:center;padding:12px 0 30px}

  .plane{
    position:relative; margin:0 auto;
    background:linear-gradient(180deg,#ffffff 0%,#f8fafc 100%);
    border:4px solid #cbd5e1; border-radius:100px;
    box-shadow:0 20px 60px rgba(0,0,0,.15),0 10px 30px rgba(0,0,0,.10),
               inset 0 0 0 3px rgba(255,255,255,.5), inset 0 0 60px rgba(0,0,0,.03);
    padding:40px 28px; overflow:visible; width:fit-content; min-width:720px;
  }
  .plane::before, .plane::after{
    content:""; position:absolute; left:50%; transform:translateX(-50%);
    width:65%; height:180px; filter:blur(18px); opacity:.35; pointer-events:none;
  }
  .plane::before{ top:-140px; background:radial-gradient(70% 100% at 50% 100%, rgba(0,0,0,.18) 0%, transparent 70%)}
  .plane::after { bottom:-140px; background:radial-gradient(70% 100% at 50% 0%,   rgba(0,0,0,.18) 0%, transparent 70%)}

  .nose,.tail{
    position:absolute; left:50%; transform:translateX(-50%);
    width:45%; height:80px; background:linear-gradient(180deg,#f1f5f9,#e2e8f0);
    border:3px solid #cbd5e1; z-index:2;
  }
  .nose{ top:-42px; border-bottom:0; border-top-left-radius:100px 80px; border-top-right-radius:100px 80px; }
  .tail{ bottom:-42px; border-top:0; border-bottom-left-radius:100px 80px; border-bottom-right-radius:100px 80px; }

  .wing{
    position:absolute; top:50%; transform:translateY(-50%);
    height:140px; width:300px; opacity:.22; pointer-events:none;
  }
  .wing.left { left:-240px;  background:conic-gradient(from 180deg at 100% 50%, #475569 0 22deg, transparent 22deg) }
  .wing.right{ right:-240px; background:conic-gradient(from   0deg at   0% 50%, #475569 0 22deg, transparent 22deg) }

  .windows{
    position:absolute; left:28px; right:28px; height:12px;
    display:flex; justify-content:space-between; z-index:3;
  }
  .windows.top{ top:28px } .windows.bottom{ bottom:28px }
  .dot{width:11px;height:11px;border-radius:999px;background:linear-gradient(135deg,#334155,#1e293b);
       box-shadow:inset 0 0 0 2px #475569, inset 0 -2px 4px rgba(0,0,0,.3), 0 1px 2px rgba(0,0,0,.2)}

  .exit-door{
    position:absolute; left:50%; transform:translateX(-50%);
    height:14px; width:22px; background:linear-gradient(90deg,#ef4444,#dc2626);
    border-radius:4px; box-shadow:0 2px 4px rgba(239,68,68,.4), inset 0 1px 0 rgba(255,255,255,.2); z-index:3;
  }

  #grid{
    position:relative; display:flex; flex-direction:column; gap:8px; padding:28px 32px;
    background:
      radial-gradient(300px 20px at 50% -8px, rgba(6,182,212,.08), transparent 70%),
      radial-gradient(300px 20px at 50% calc(100% + 8px), rgba(6,182,212,.08), transparent 70%);
    border-radius:70px;
  }
  .row{display:flex; align-items:center; gap:14px; padding:8px 10px}
  .rownum,.cabin{width:58px; text-align:center; font-weight:700; color:var(--muted); font-size:12px}
  .group{display:flex; gap:10px; padding:0 12px; border-left:2px dashed rgba(203,213,225,.5); border-right:2px dashed rgba(203,213,225,.5)}

  /* seats */
  .seat{
    width:34px;height:40px;border-radius:10px;background:linear-gradient(145deg,#ffffff,#f8fafc);
    border:2px solid #cbd5e1; cursor:pointer; position:relative; transition:all .15s cubic-bezier(.4,0,.2,1);
    box-shadow:0 1px 3px rgba(0,0,0,.1), inset 0 1px 0 rgba(255,255,255,.5);
  }
  .seat::before{content:"";position:absolute;top:5px;left:6px;right:6px;height:8px;border-radius:5px;background:linear-gradient(180deg,#e2e8f0,#cbd5e1)}
  .seat::after {content:"";position:absolute;bottom:5px;left:5px;right:5px;height:18px;border-radius:7px;border:1.5px dashed #cbd5e1}
  .seat:hover:not(:disabled){transform:translateY(-2px) scale(1.05); box-shadow:0 4px 12px rgba(14,165,233,.25),0 0 0 4px rgba(14,165,233,.1); border-color:#0ea5e9}
  .seat.selected{background:linear-gradient(145deg,#0ea5e9,#0284c7);border-color:#0284c7;transform:scale(1.1);box-shadow:0 4px 12px rgba(14,165,233,.4),0 0 0 4px rgba(14,165,233,.2)}
  .seat.busy{background:linear-gradient(145deg,#cbd5e1,#94a3b8);border-color:#94a3b8;cursor:not-allowed;opacity:.7}
  .seat.held{background:linear-gradient(145deg,#e2e8f0,#cbd5e1);border-color:#cbd5e1;cursor:not-allowed;opacity:.8}
  .seat.blocked{background:linear-gradient(145deg,#334155,#1e293b);border-color:#1e293b;cursor:not-allowed;opacity:.6}
  .seat.ghost{opacity:0; pointer-events:none}

  /* cabins */
  .cabinFirst{background:linear-gradient(90deg,rgba(168,85,247,.08),transparent);border-radius:14px}
  .cabinBusiness{background:linear-gradient(90deg,rgba(6,182,212,.08),transparent);border-radius:12px}
  .cabinEconomy{background:linear-gradient(90deg,rgba(16,185,129,.08),transparent);border-radius:12px}
  .badgeFirst{color:var(--first);font-weight:800}
  .badgeBusiness{color:var(--biz);font-weight:800}
  .badgeEconomy{color:var(--econ);font-weight:800}

  .cabinFirst .seat{width:46px;height:52px;border-radius:12px}
  .cabinFirst .group{gap:14px;padding:0 16px}
  .cabinBusiness .seat{width:40px;height:46px}
  .cabinBusiness .group{gap:14px;padding:0 16px}
  .cabinEconomy .seat{width:32px;height:38px}
  .cabinEconomy .group{gap:8px;padding:0 12px}

  .exitRow{outline:3px solid rgba(239,68,68,.28); outline-offset:-4px; border-radius:10px; position:relative; background:linear-gradient(90deg,rgba(239,68,68,.04),transparent)}
  .exitRow::after{content:"EXIT ROW"; position:absolute; right:8px; top:-10px; font-size:11px; font-weight:800; color:#dc2626; background:#fff; padding:2px 6px; border-radius:6px; border:2px solid #fca5a5}

  .actions{
    position:fixed; left:50%; transform:translateX(-50%); bottom:16px;
    width:min(1120px, calc(100% - 32px));
    display:flex; justify-content:space-between; align-items:center; gap:14px;
    background:rgba(255,255,255,.96); backdrop-filter:blur(14px);
    padding:16px 20px; border-radius:16px; border:1px solid rgba(0,0,0,.08);
    box-shadow:0 -10px 30px rgba(15,23,42,.12), 0 12px 36px rgba(14,165,233,.15);
    z-index:30;
  }
  .actions .left{flex:1; min-width:0;}
  .summary-title{font-size:13px; text-transform:uppercase; letter-spacing:.4px; color:var(--muted); font-weight:700; margin-bottom:4px;}
  .pax-chips{display:flex; flex-wrap:wrap; gap:8px;}
  .p-chip{
    display:flex; flex-direction:column; align-items:flex-start;
    border:1px solid rgba(14,165,233,.2); border-radius:14px; padding:10px 12px;
    background:linear-gradient(145deg,rgba(255,255,255,.96),rgba(226,244,255,.9));
    min-width:136px; cursor:pointer;
    box-shadow:0 10px 24px rgba(14,165,233,.14);
    transition:all .15s ease;
  }
  .p-chip.active{border-color:#0284c7; box-shadow:0 0 0 3px rgba(2,132,199,.25);}
  .p-chip strong{color:#0b2545; letter-spacing:0.2px;}
  .p-chip small{color:#0ea5e9; font-weight:700; text-transform:uppercase; letter-spacing:.3px;}
  .total{font-weight:800;font-size:18px;background:linear-gradient(135deg,#0ea5e9,#06b6d4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .btn{background:linear-gradient(135deg,#0ea5e9,#06b6d4); color:#fff; border:0; border-radius:12px; padding:14px 28px; font-weight:700; font-size:15px; cursor:pointer}
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .summary-sub{color:#475569; font-size:13px; margin-top:4px;}
</style>
</head>
<body>
<header><h1>‚úàÔ∏è Seat Selection</h1></header>

<div class="wrap">
  <div class="meta">
    <div>‚úàÔ∏è <strong>Flight:</strong> <span id="flight-label"></span></div>
    <div>ü™ë <strong>Layout:</strong> <span id="layout-label"></span></div>
    <div>üë• <strong>Passengers:</strong> <span id="passenger-count"></span></div>
    <div id="legend">
      <span class="pill"><span class="sw available"></span>Available</span>
      <span class="pill"><span class="sw selected"></span>Selected</span>
      <span class="pill"><span class="sw busy"></span>Occupied</span>
      <span class="pill"><span class="sw held"></span>Held</span>
      <span class="pill"><span class="sw blocked"></span>Blocked</span>
      <span class="pill"><span class="sw exit"></span>Exit Row</span>
    </div>
  </div>

  <div class="stage">
    <div class="plane" id="plane">
      <!-- top/bottom caps -->
      <div class="nose"></div>
      <div class="tail"></div>

      <!-- wings -->
      <div class="wing left"></div>
      <div class="wing right"></div>

      <div class="windows top" id="w-top"></div>
      <div class="windows bottom" id="w-btm"></div>

      <div class="exit-door" style="top:18%"></div>
      <div class="exit-door" style="top:82%"></div>

      <!-- seat grid -->
      <div id="grid" data-flight-id=""></div>
    </div>
  </div>
</div>

<div class="actions" aria-live="polite">
  <div class="left">
    <div class="summary-title">Seat summary</div>
    <div class="pax-chips" id="pax-chips"></div>
  </div>
  <div class="right text-end">
    <div class="total">üé´ <span id="total">0 seats</span></div>
    <div class="summary-sub">Active: <span id="active-label">Passenger 1</span></div>
  </div>
  <div>
    <button id="continue" class="btn" disabled data-booking-url="{{ url_for('booking.new_booking') }}">Continue to Checkout</button>
  </div>
</div>

<!-- server-provided seed data for JS; keeps inline script error-free -->
<script id="seat-seed" type="application/json">
  {{ {"passenger_count": passenger_count, "preselected_seats": preselected_seats}|tojson }}
</script>

<script>
  const path = location.pathname.split('/').filter(Boolean);
  const qs = new URLSearchParams(location.search);
  const flightIdFromPath = path.includes('flights') ? path[path.indexOf('flights') + 1] : null;
  const flightId = flightIdFromPath || qs.get('flight_id');

  if (!flightId) {
    alert('No flight id provided for seat selection.');
    throw new Error('Missing flight id');
  }

  const grid = document.getElementById('grid');
  const wTop = document.getElementById('w-top');
  const wBtm = document.getElementById('w-btm');
  const chips = document.getElementById('pax-chips');
  const activeLabel = document.getElementById('active-label');
  const passengerCountEl = document.getElementById('passenger-count');
  grid.dataset.flightId = flightId;

  let serverPax = null;
  let presetSeatsRaw = [];
  try {
    const seed = document.getElementById('seat-seed')?.textContent || '{}';
    const parsed = JSON.parse(seed);
    serverPax = parsed?.passenger_count ?? null;
    const raw = parsed?.preselected_seats;
    presetSeatsRaw = Array.isArray(raw) ? raw : [];
  } catch (err) {
    console.warn('Failed to parse seat seed data', err);
  }
  const paxFromQuery = Number(qs.get('pax')) || 0;
  const paxFromSession = Number(sessionStorage.getItem('passengerCount')) || 0;
  const presetSeats = Array.isArray(presetSeatsRaw) ? presetSeatsRaw : [];

  let passengerCount = Number.isFinite(Number(serverPax)) ? Number(serverPax) : 0;
  passengerCount = passengerCount || paxFromQuery || paxFromSession || 1;
  if (!Number.isFinite(passengerCount) || passengerCount < 1) passengerCount = 1;
  passengerCount = Math.round(passengerCount);
  sessionStorage.setItem('passengerCount', String(passengerCount));
  passengerCountEl.textContent = passengerCount;

  if(!presetSeats || presetSeats.length === 0){
    sessionStorage.removeItem(`seats:${flightId}`);
  }
  const initialSeats = Array.isArray(presetSeats) && presetSeats.length ? presetSeats : [];

  const state = {
    origin:"", destination:"", depart_time:"",
    layout:"", rows:0, classes:[],
    occupied:new Set(), held:new Set(), blocked:new Set(),
    prices:{},
    selectedSeats:Array.from({length: passengerCount}, (_,i)=>initialSeats[i] || null),
    exit_rows:[]
  };

  let activePassenger = Math.max(0, state.selectedSeats.findIndex(seat => !seat));
  if (activePassenger === -1) activePassenger = 0;

  const totalEl = document.getElementById('total');
  const continueBtn = document.getElementById('continue');

  const cabinForRow = r => {
    for(const b of state.classes){ if(r>=b.from && r<=b.to) return b.class; }
    return "Economy";
  };
  const badgeCls  = c => c==="First" ? "badgeFirst" : c==="Business" ? "badgeBusiness" : "badgeEconomy";
  const cabinWrap = c => c==="First" ? "cabinFirst" : c==="Business" ? "cabinBusiness" : "cabinEconomy";

  function groupsForRow(r){
    const cabin = cabinForRow(r);
    if (cabin === "Business") return ["AB","CD"];
    return state.layout.split(' ');
  }
  function isGhostSeat(cabin, ch){
    return (cabin === "Business" && (ch === "E" || ch === "F"));
  }

  function buildWindows(count=28){
    wTop.innerHTML=""; wBtm.innerHTML="";
    for(let i=0;i<count;i++){
      const d1=document.createElement('div'); d1.className='dot';
      const d2=document.createElement('div'); d2.className='dot';
      wTop.appendChild(d1); wBtm.appendChild(d2);
    }
  }

  function inferExitRows(){
    if(state.exit_rows && state.exit_rows.length) return;
    let boundary=null;
    for(const b of state.classes){
      if(b.class==="Business") boundary=b.to;
      if(b.class==="Economy" && boundary!==null) break;
    }
    const g1 = boundary ? boundary + 1 : Math.max(6, Math.round(state.rows*0.25));
    const g2 = Math.min(state.rows-2, g1 + 9);
    state.exit_rows = Array.from(new Set([g1,g2])).filter(n=>n>=2 && n<=state.rows-1);
  }

  function renderGrid(){
    grid.innerHTML = '';
    inferExitRows();

    for(let r=1;r<=state.rows;r++){
      const cabin = cabinForRow(r);
      const rowEl = document.createElement('div');
      rowEl.className = `row ${cabinWrap(cabin)} ${state.exit_rows.includes(r) ? 'exitRow' : ''}`;

      const n = document.createElement('div'); n.className='rownum'; n.textContent = String(r).padStart(2,'0');
      rowEl.appendChild(n);

      const groups = groupsForRow(r);
      for(const g of groups){
        const gEl = document.createElement('div'); gEl.className='group';
        for(const ch of g){
          const code = `${r}${ch}`;
          const btn = document.createElement('button');
          btn.type='button'; btn.className='seat'; btn.dataset.code=code; btn.title=code;

          if (isGhostSeat(cabin, ch)){
            btn.classList.add('ghost'); gEl.appendChild(btn); continue;
          }
          if(state.blocked.has(code)){ btn.classList.add('blocked'); btn.disabled=true; }
          else if(state.occupied.has(code)){ btn.classList.add('busy'); btn.disabled=true; }
          else if(state.held.has(code)){ btn.classList.add('held'); btn.disabled=true; }

          btn.addEventListener('click', ()=>toggleSeat(code, btn));
          gEl.appendChild(btn);
        }
        rowEl.appendChild(gEl);
      }

      const badge = document.createElement('div');
      badge.className = `cabin ${badgeCls(cabin)}`;
      badge.textContent = cabin;
      rowEl.appendChild(badge);

      grid.appendChild(rowEl);
    }

    const departDate = state.depart_time ? new Date(state.depart_time) : null;
    const departLabel = departDate && !Number.isNaN(departDate.getTime())
      ? departDate.toLocaleString()
      : '‚Äî';
    const label = `${state.origin || '‚Äî'} ‚Üí ${state.destination || '‚Äî'} (${departLabel})`;
    document.getElementById('flight-label').textContent = label;
    document.getElementById('layout-label').textContent = state.layout || '‚Äî';

    buildWindows(Math.max(20, Math.min(36, Math.round(state.rows*0.55))));
    restoreSelections();
    renderPassengers();
    updateTotal();
  }

  function restoreSelections(){
    state.selectedSeats.forEach(code=>{
      if(!code) return;
      const el=document.querySelector(`.seat[data-code="${code}"]`);
      if(el && !el.disabled) el.classList.add('selected');
    });
  }

  function renderPassengers(){
    chips.innerHTML='';
    state.selectedSeats.forEach((seat, idx)=>{
      const chip=document.createElement('button');
      chip.type='button';
      chip.className=`p-chip ${idx===activePassenger?'active':''}`;
      chip.innerHTML=`<small>Passenger ${idx+1}</small><strong>${seat || 'Select seat'}</strong>`;
      chip.addEventListener('click', ()=>{
        activePassenger = idx;
        renderPassengers();
      });
      chips.appendChild(chip);
    });
    activeLabel.textContent = `Passenger ${activePassenger+1}`;
  }

  function persistLocal(){
    sessionStorage.setItem(`seats:${flightId}`, JSON.stringify(state.selectedSeats));
    sessionStorage.setItem('passengerCount', String(passengerCount));
  }

  function toggleSeat(code, btn){
    const assignedIdx = state.selectedSeats.findIndex(seat => seat === code);
    const prevForActive = state.selectedSeats[activePassenger];

    if (assignedIdx === activePassenger){
      state.selectedSeats[activePassenger] = null;
      btn.classList.remove('selected');
    } else {
      if (assignedIdx !== -1){
        state.selectedSeats[assignedIdx] = null;
        const prevBtn = document.querySelector(`.seat[data-code="${code}"]`);
        prevBtn?.classList.remove('selected');
      }
      if (prevForActive){
        const old = document.querySelector(`.seat[data-code="${prevForActive}"]`);
        old?.classList.remove('selected');
      }
      state.selectedSeats[activePassenger] = code;
      btn.classList.add('selected');

      const nextIdx = state.selectedSeats.findIndex((seat, idx)=>!seat && idx>=activePassenger);
      if(nextIdx !== -1) activePassenger = nextIdx;
    }
    persistLocal();
    renderPassengers();
    updateTotal();
  }

  function updateTotal(){
    const filled = state.selectedSeats.filter(Boolean).length;
    const pax = Number(passengerCount) || 1;
    totalEl.textContent = `${filled}/${pax} seat${pax!==1?'s':''}`;
    continueBtn.disabled = filled !== pax;
  }

  async function saveSelection(){
    const payload = {
      flight_id: Number(flightId),
      passenger_count: passengerCount,
      seat_map: state.selectedSeats,
      seats: state.selectedSeats.filter(Boolean),
    };
    const res = await fetch('/api/booking/selection', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload),
    });
    if(!res.ok){
      throw new Error('Could not save seats. Please try again.');
    }
  }

  continueBtn.addEventListener('click', async ()=>{
    if (!flightId){
      alert('Missing flight id.');
      return;
    }
    const base = continueBtn.dataset.bookingUrl;  
    continueBtn.disabled = true;
    continueBtn.textContent = "Saving...";
    try{
      await saveSelection();
      window.location.href = `${base}?flight_id=${encodeURIComponent(flightId)}&pax=${passengerCount}`;
    }catch(err){
      alert(err.message);
      continueBtn.disabled = false;
      continueBtn.textContent = "Continue to Checkout";
    }
  });



  (async function init(){
    try{
      const res = await fetch(`/api/flights/${encodeURIComponent(flightId)}/seats`);
      if(!res.ok){
        const msg = await res.text();
        throw new Error(msg || 'Failed to load seats');
      }
      const data = await res.json();
      state.origin = data.origin; state.destination = data.destination; state.depart_time = data.depart_time;
      state.layout = data.layout; state.rows = data.rows; state.classes = data.classes || [];
      state.prices = data.prices || {};
      state.occupied = new Set(data.occupied || []);
      state.held = new Set(data.held || []);
      state.blocked = new Set(data.blocked || []);
      state.exit_rows = data.exit_rows || [];
      renderGrid();
    }catch(err){
      alert(err.message || 'Unable to load seat map.'); 
      console.error(err);
    }
  })();
</script>
</body>
</html>
