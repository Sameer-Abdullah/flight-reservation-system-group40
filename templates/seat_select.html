<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Select Seats</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --ink:#0a1f44; --muted:#64748b; --ring:#bfdbfe; --ok:#0ea5e9;
    --busy:#94a3b8; --held:#cbd5e1; --blocked:#1e293b;
    --first:#a855f7; --biz:#06b6d4; --econ:#10b981;
    --f-bg:#faf5ff; --b-bg:#ecfeff; --e-bg:#f0fdf4;
    --exit:#ef4444;
    --metal:#d1d5db; --metal-deep:#9ca3af; --shadow:rgba(10,31,68,.12);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    background:linear-gradient(135deg,#0ea5e9 0%,#38bdf8 100%);
    color:#111; min-height:100svh; display:flex; flex-direction:column;
    position:relative; overflow-x:hidden; padding-bottom:140px;
  }
  body::before{
    content:""; position:fixed; inset:0;
    background-image:
      radial-gradient(circle at 20% 50%, rgba(255,255,255,.08) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(255,255,255,.06) 0%, transparent 50%);
    animation:float 20s ease-in-out infinite; pointer-events:none;
  }
  @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}

  header{
    position:sticky; top:0; z-index:10;
    background:rgba(255,255,255,.95); backdrop-filter:blur(12px);
    border-bottom:1px solid rgba(0,0,0,.06); padding:20px 24px;
  }
  header h1{margin:0;font-size:24px;font-weight:700;
    background:linear-gradient(135deg,#0ea5e9,#06b6d4);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
  }

  .wrap{max-width:1100px;margin:30px auto;padding:0 20px;display:flex;flex-direction:column;align-items:center;gap:24px}

  .meta{
    display:flex; gap:24px; flex-wrap:wrap; align-items:center; color:#1e293b;
    background:rgba(255,255,255,.95); backdrop-filter:blur(12px);
    border:1px solid rgba(0,0,0,.08); border-radius:16px; padding:16px 20px; font-size:14px; font-weight:500;
  }
  #legend{display:flex; gap:12px; flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(0,0,0,.08);border-radius:999px;padding:6px 12px;font-size:13px;background:rgba(255,255,255,.8)}
  .sw{width:16px;height:16px;border-radius:4px;border:1.5px solid #e2e8f0}
  .sw.available{background:#fff}
  .sw.selected{background:var(--ok);border-color:var(--ok);box-shadow:0 0 0 2px rgba(14,165,233,.2)}
  .sw.busy{background:var(--busy);border-color:var(--busy)}
  .sw.held{background:var(--held);border-color:var(--held)}
  .sw.blocked{background:var(--blocked);border-color:var(--blocked)}
  .sw.exit{background:var(--exit);border-color:var(--exit)}

  .stage{width:100%;display:flex;justify-content:center;padding:12px 0 30px}

  .plane{
    position:relative; margin:0 auto;
    background:linear-gradient(180deg,#ffffff 0%,#f8fafc 100%);
    border:4px solid #cbd5e1; border-radius:100px;
    box-shadow:0 20px 60px rgba(0,0,0,.15),0 10px 30px rgba(0,0,0,.10),
               inset 0 0 0 3px rgba(255,255,255,.5), inset 0 0 60px rgba(0,0,0,.03);
    padding:40px 28px; overflow:visible; width:fit-content; min-width:720px;
  }
  .plane::before, .plane::after{
    content:""; position:absolute; left:50%; transform:translateX(-50%);
    width:65%; height:180px; filter:blur(18px); opacity:.35; pointer-events:none;
  }
  .plane::before{ top:-140px; background:radial-gradient(70% 100% at 50% 100%, rgba(0,0,0,.18) 0%, transparent 70%)}
  .plane::after { bottom:-140px; background:radial-gradient(70% 100% at 50% 0%,   rgba(0,0,0,.18) 0%, transparent 70%)}

  .nose,.tail{
    position:absolute; left:50%; transform:translateX(-50%);
    width:45%; height:80px; background:linear-gradient(180deg,#f1f5f9,#e2e8f0);
    border:3px solid #cbd5e1; z-index:2;
  }
  .nose{ top:-42px; border-bottom:0; border-top-left-radius:100px 80px; border-top-right-radius:100px 80px; }
  .tail{ bottom:-42px; border-top:0; border-bottom-left-radius:100px 80px; border-bottom-right-radius:100px 80px; }

  .wing{
    position:absolute; top:50%; transform:translateY(-50%);
    height:140px; width:300px; opacity:.22; pointer-events:none;
  }
  .wing.left { left:-240px;  background:conic-gradient(from 180deg at 100% 50%, #475569 0 22deg, transparent 22deg) }
  .wing.right{ right:-240px; background:conic-gradient(from   0deg at   0% 50%, #475569 0 22deg, transparent 22deg) }

  .windows{
    position:absolute; left:28px; right:28px; height:12px;
    display:flex; justify-content:space-between; z-index:3;
  }
  .windows.top{ top:28px } .windows.bottom{ bottom:28px }
  .dot{width:11px;height:11px;border-radius:999px;background:linear-gradient(135deg,#334155,#1e293b);
       box-shadow:inset 0 0 0 2px #475569, inset 0 -2px 4px rgba(0,0,0,.3), 0 1px 2px rgba(0,0,0,.2)}

  .exit-door{
    position:absolute; left:50%; transform:translateX(-50%);
    height:14px; width:22px; background:linear-gradient(90deg,#ef4444,#dc2626);
    border-radius:4px; box-shadow:0 2px 4px rgba(239,68,68,.4), inset 0 1px 0 rgba(255,255,255,.2); z-index:3;
  }

  #grid{
    position:relative; display:flex; flex-direction:column; gap:8px; padding:28px 32px;
    background:
      radial-gradient(300px 20px at 50% -8px, rgba(6,182,212,.08), transparent 70%),
      radial-gradient(300px 20px at 50% calc(100% + 8px), rgba(6,182,212,.08), transparent 70%);
    border-radius:70px;
  }
  .row{display:flex; align-items:center; gap:14px; padding:8px 10px}
  .rownum,.cabin{width:58px; text-align:center; font-weight:700; color:var(--muted); font-size:12px}
  .group{display:flex; gap:10px; padding:0 12px; border-left:2px dashed rgba(203,213,225,.5); border-right:2px dashed rgba(203,213,225,.5)}

  /* seats */
  .seat{
    width:34px;height:40px;border-radius:10px;background:linear-gradient(145deg,#ffffff,#f8fafc);
    border:2px solid #cbd5e1; cursor:pointer; position:relative; transition:all .15s cubic-bezier(.4,0,.2,1);
    box-shadow:0 1px 3px rgba(0,0,0,.1), inset 0 1px 0 rgba(255,255,255,.5);
  }
  .seat::before{content:"";position:absolute;top:5px;left:6px;right:6px;height:8px;border-radius:5px;background:linear-gradient(180deg,#e2e8f0,#cbd5e1)}
  .seat::after {content:"";position:absolute;bottom:5px;left:5px;right:5px;height:18px;border-radius:7px;border:1.5px dashed #cbd5e1}
  .seat:hover:not(:disabled){transform:translateY(-2px) scale(1.05); box-shadow:0 4px 12px rgba(14,165,233,.25),0 0 0 4px rgba(14,165,233,.1); border-color:#0ea5e9}
  .seat.selected{background:linear-gradient(145deg,#0ea5e9,#0284c7);border-color:#0284c7;transform:scale(1.1);box-shadow:0 4px 12px rgba(14,165,233,.4),0 0 0 4px rgba(14,165,233,.2)}
  .seat.busy{background:linear-gradient(145deg,#cbd5e1,#94a3b8);border-color:#94a3b8;cursor:not-allowed;opacity:.7}
  .seat.held{background:linear-gradient(145deg,#e2e8f0,#cbd5e1);border-color:#cbd5e1;cursor:not-allowed;opacity:.8}
  .seat.blocked{background:linear-gradient(145deg,#334155,#1e293b);border-color:#1e293b;cursor:not-allowed;opacity:.6}
  .seat.ghost{opacity:0; pointer-events:none}

  /* cabins */
  .cabinFirst{background:linear-gradient(90deg,rgba(168,85,247,.08),transparent);border-radius:14px}
  .cabinBusiness{background:linear-gradient(90deg,rgba(6,182,212,.08),transparent);border-radius:12px}
  .cabinEconomy{background:linear-gradient(90deg,rgba(16,185,129,.08),transparent);border-radius:12px}
  .badgeFirst{color:var(--first);font-weight:800}
  .badgeBusiness{color:var(--biz);font-weight:800}
  .badgeEconomy{color:var(--econ);font-weight:800}

  .cabinFirst .seat{width:46px;height:52px;border-radius:12px}
  .cabinFirst .group{gap:14px;padding:0 16px}
  .cabinBusiness .seat{width:40px;height:46px}
  .cabinBusiness .group{gap:14px;padding:0 16px}
  .cabinEconomy .seat{width:32px;height:38px}
  .cabinEconomy .group{gap:8px;padding:0 12px}

  .exitRow{outline:3px solid rgba(239,68,68,.28); outline-offset:-4px; border-radius:10px; position:relative; background:linear-gradient(90deg,rgba(239,68,68,.04),transparent)}
  .exitRow::after{content:"EXIT ROW"; position:absolute; right:8px; top:-10px; font-size:11px; font-weight:800; color:#dc2626; background:#fff; padding:2px 6px; border-radius:6px; border:2px solid #fca5a5}

  .actions{
    position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    width:min(1180px, calc(100% - 16px));
    background:linear-gradient(180deg,#ffffff 0%,#f8fafc 100%);
    backdrop-filter:blur(10px); padding:10px 12px; border-radius:17px;
    border:1px solid rgba(2,6,23,.06); box-shadow:0 14px 32px rgba(2,6,23,.16);
    z-index:50;
  }
  .seat-summary-card{
    flex:1; min-width:300px;
    background:transparent;
    border-radius:0; border:0; padding:0;
    box-shadow:none;
  }
  .summary-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;}
  .summary-title{font-weight:900; color:#334155; letter-spacing:.03em;}
  .summary-sub{display:none;}
  .passenger-list{
    display:grid;
    grid-auto-flow:row;
    grid-template-columns:repeat(4, 190px);
    grid-auto-rows:auto;
    justify-content:flex-start;
    gap:6px;
    margin-bottom:2px;
  }
  .pax-chip{
    flex:0 1 180px; display:flex; flex-direction:column; gap:2px; align-items:flex-start;
    border:1.25px solid #c7e3ff; border-radius:12px; padding:8px 11px;
    background:linear-gradient(180deg,#eaf4ff,#f8fbff); color:#0284c7;
    box-shadow:0 6px 18px rgba(2,6,23,.06); transition:.15s ease; cursor:pointer; text-align:left;
  }
  .pax-chip:hover{transform:translateY(-2px);}
  .pax-chip.active{border-color:#0ea5e9; box-shadow:0 0 0 2px rgba(14,165,233,.18), 0 10px 22px rgba(2,6,23,.10);}
  .pax-label{font-size:11px; text-transform:uppercase; letter-spacing:.08em; font-weight:800; color:#0284c7;}
  .pax-seat{font-weight:800; font-size:16px; color:#0b0f19;}
  .pax-meta{color:#64748b; font-size:11px;}
  .pax-chip.empty .pax-seat{color:#94a3b8;}

  .cta{display:flex; align-items:center; gap:10px; min-width:260px; justify-content:flex-end; flex:1 0 auto;}
  .cta-info{display:flex; flex-direction:column; align-items:flex-start; gap:2px;}
  .total{font-weight:900;font-size:18px;color:#1d9ee5; display:flex; align-items:center; gap:8px;}
  .seat-dot{display:inline-block;width:14px;height:14px;border-radius:4px;background:linear-gradient(135deg,#0ea5e9,#06b6d4);box-shadow:0 0 0 2px rgba(14,165,233,.12);}
  .active-tag{color:#7b8794; font-weight:700; font-size:12px;}
  .btn{background:linear-gradient(135deg,#0ea5e9,#06b6d4); color:#fff; border:0; border-radius:14px; padding:12px 22px; font-weight:800; font-size:15px; cursor:pointer; box-shadow:0 10px 20px rgba(2,6,23,.14); height:54px; display:flex; align-items:center; justify-content:center;}
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .seat.active-seat{box-shadow:0 0 0 4px rgba(14,165,233,.28),0 8px 18px rgba(14,165,233,.20)}
  @media(max-width: 900px){
    .seat-summary-card{min-width:100%;}
    .passenger-list{
      grid-auto-flow:row;
      grid-template-rows:none;
      grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
      grid-auto-columns: unset;
    }
    .cta{align-items:flex-start;}
    .actions{width:calc(100% - 16px); padding:14px;}
  }
</style>
</head>
<body>
<header><h1>‚úàÔ∏è Seat Selection</h1></header>

<div class="wrap">
  <div class="meta">
    <div>‚úàÔ∏è <strong>Flight:</strong> <span id="flight-label"></span></div>
    <div>ü™ë <strong>Layout:</strong> <span id="layout-label"></span></div>
    <div id="legend">
      <span class="pill"><span class="sw available"></span>Available</span>
      <span class="pill"><span class="sw selected"></span>Selected</span>
      <span class="pill"><span class="sw busy"></span>Occupied</span>
      <span class="pill"><span class="sw held"></span>Held</span>
      <span class="pill"><span class="sw blocked"></span>Blocked</span>
      <span class="pill"><span class="sw exit"></span>Exit Row</span>
    </div>
  </div>

  <div class="stage">
    <div class="plane" id="plane">
      <!-- top/bottom caps -->
      <div class="nose"></div>
      <div class="tail"></div>

      <!-- wings -->
      <div class="wing left"></div>
      <div class="wing right"></div>

      <div class="windows top" id="w-top"></div>
      <div class="windows bottom" id="w-btm"></div>

      <div class="exit-door" style="top:18%"></div>
      <div class="exit-door" style="top:82%"></div>

      <!-- seat grid -->
      <div id="grid" data-flight-id=""></div>
    </div>
  </div>

  <div class="actions">
    <div class="seat-summary-card">
      <div class="summary-head">
        <div class="summary-title">Seat Summary</div>
        <div class="summary-sub" id="seatSummaryHint"></div>
      </div>
      <div id="passengerList" class="passenger-list"></div>
    </div>
    <div class="cta">
      <div class="cta-info">
        <div class="total"><span class="seat-dot" aria-hidden="true"></span><span id="total">0/1 seats</span></div>
        <div class="active-tag">Active: <span id="active-passenger">Passenger 1</span></div>
      </div>
      <button id="continue" class="btn" disabled   data-booking-url="{{ url_for('booking.new_booking') }}">Continue to Details</button>
    </div>
  </div>
</div>

<script>
  const path = location.pathname.split('/').filter(Boolean);
  const flightId = path[path.indexOf('flights') + 1];
  const params = new URLSearchParams(location.search);
  const paxParam = parseInt(params.get('pax') || '1', 10);
  const resetParam = params.has('reset');
  const passengerCount = Number.isFinite(paxParam) ? Math.min(Math.max(paxParam, 1), 9) : 1;
  const STORAGE_KEY = `sw-seat-${flightId}`;

  const grid = document.getElementById('grid');
  const wTop = document.getElementById('w-top');
  const wBtm = document.getElementById('w-btm');
  const passengerListEl = document.getElementById('passengerList');
  const seatSummaryHint = document.getElementById('seatSummaryHint');
  const activeLabel = document.getElementById('active-passenger');
  grid.dataset.flightId = flightId;

  const state = {
    origin:"", destination:"", depart_time:"",
    layout:"", rows:0, classes:[],
    occupied:new Set(), held:new Set(), blocked:new Set(),
    prices:{},
    exit_rows:[],
    pax: passengerCount,
    passengers: [],
    seatToPassenger: Object.create(null),
    activePassenger: 0,
    fingerprint: ""
  };

  const totalEl = document.getElementById('total');
  const continueBtn = document.getElementById('continue');

  const cabinForRow = r => {
    for(const b of state.classes){ if(r>=b.from && r<=b.to) return b.class; }
    return "Economy";
  };
  const badgeCls  = c => c==="First" ? "badgeFirst" : c==="Business" ? "badgeBusiness" : "badgeEconomy";
  const cabinWrap = c => c==="First" ? "cabinFirst" : c==="Business" ? "cabinBusiness" : "cabinEconomy";

  function groupsForRow(r){
    const cabin = cabinForRow(r);
    if (cabin === "Business") return ["AB","CD"];
    return state.layout.split(' ');
  }
  function isGhostSeat(cabin, ch){
    return (cabin === "Business" && (ch === "E" || ch === "F"));
  }

  function buildWindows(count=28){
    wTop.innerHTML=""; wBtm.innerHTML="";
    for(let i=0;i<count;i++){
      const d1=document.createElement('div'); d1.className='dot';
      const d2=document.createElement('div'); d2.className='dot';
      wTop.appendChild(d1); wBtm.appendChild(d2);
    }
  }

  function inferExitRows(){
    if(state.exit_rows && state.exit_rows.length) return;
    let boundary=null;
    for(const b of state.classes){
      if(b.class==="Business") boundary=b.to;
      if(b.class==="Economy" && boundary!==null) break;
    }
    const g1 = boundary ? boundary + 1 : Math.max(6, Math.round(state.rows*0.25));
    const g2 = Math.min(state.rows-2, g1 + 9);
    state.exit_rows = Array.from(new Set([g1,g2])).filter(n=>n>=2 && n<=state.rows-1);
  }

  function renderGrid(){
    grid.innerHTML = '';
    inferExitRows();

    for(let r=1;r<=state.rows;r++){
      const cabin = cabinForRow(r);
      const rowEl = document.createElement('div');
      rowEl.className = `row ${cabinWrap(cabin)} ${state.exit_rows.includes(r) ? 'exitRow' : ''}`;

      const n = document.createElement('div'); n.className='rownum'; n.textContent = String(r).padStart(2,'0');
      rowEl.appendChild(n);

      const groups = groupsForRow(r);
      for(const g of groups){
        const gEl = document.createElement('div'); gEl.className='group';
        for(const ch of g){
          const code = `${r}${ch}`;
          const btn = document.createElement('button');
          btn.type='button'; btn.className='seat'; btn.dataset.code=code; btn.title=code;

          if (isGhostSeat(cabin, ch)){
            btn.classList.add('ghost'); gEl.appendChild(btn); continue;
          }
          if(state.blocked.has(code)){ btn.classList.add('blocked'); btn.disabled=true; }
          else if(state.occupied.has(code)){ btn.classList.add('busy'); btn.disabled=true; }
          else if(state.held.has(code)){ btn.classList.add('held'); btn.disabled=true; }

          if(state.seatToPassenger[code] !== undefined){
            btn.classList.add('selected');
            if(state.seatToPassenger[code] === state.activePassenger){
              btn.classList.add('active-seat');
            }
          }

          btn.addEventListener('click', ()=>onSeatClick(code, btn));
          gEl.appendChild(btn);
        }
        rowEl.appendChild(gEl);
      }

      const badge = document.createElement('div');
      badge.className = `cabin ${badgeCls(cabin)}`;
      badge.textContent = cabin;
      rowEl.appendChild(badge);

      grid.appendChild(rowEl);
    }

    const label = `${state.origin} ‚Üí ${state.destination} (${new Date(state.depart_time).toLocaleString()})`;
    document.getElementById('flight-label').textContent = label;
    document.getElementById('layout-label').textContent = state.layout;

    buildWindows(Math.max(20, Math.min(36, Math.round(state.rows*0.55))));
  }

  const seatPosition = (letter) => {
    const groups = state.layout.split(' ').filter(Boolean);
    for(let i=0;i<groups.length;i++){
      const g = groups[i]; const idx = g.indexOf(letter);
      if(idx === -1) continue;
      const isFirst = i === 0; const isLast = i === groups.length-1;
      if(idx === 0) return isFirst ? "Window" : "Aisle";
      if(idx === g.length-1) return isLast ? "Window" : "Aisle";
      return "Middle";
    }
    return "Seat";
  };

  function parseSeat(code){
    const m = /^(\d+)([A-Z])$/.exec(code || "");
    if(!m) return null;
    return { row: parseInt(m[1], 10), letter: m[2] };
  }

  function seatDetails(code){
    const parsed = parseSeat(code);
    if(!parsed) return { code, cabin:"", position:"" };
    const cabin = cabinForRow(parsed.row);
    const position = seatPosition(parsed.letter);
    return { code, cabin, position, row: parsed.row, letter: parsed.letter };
  }

  function createPassenger(idx){
    return { label: `Passenger ${idx+1}`, seatCode:"", cabin:"", position:"", row:null, letter:"" };
  }

  function selectedCount(){
    return state.passengers.filter(p=>p.seatCode).length;
  }

  function refreshSeatClasses(){
    document.querySelectorAll('.seat').forEach(el=>{
      const owner = state.seatToPassenger[el.dataset.code];
      el.classList.toggle('selected', owner !== undefined);
      el.classList.toggle('active-seat', owner === state.activePassenger);
    });
  }

  function updateTotals(){
    const count = selectedCount();
    totalEl.textContent = `${count}/${state.passengers.length} seats`;
    activeLabel.textContent = `Passenger ${state.activePassenger+1}`;
    continueBtn.disabled = count !== state.passengers.length;
  }

  function renderPassengers(){
    passengerListEl.innerHTML = '';
    state.passengers.forEach((p, idx)=>{
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = `pax-chip ${p.seatCode ? '' : 'empty'} ${idx===state.activePassenger ? 'active' : ''}`;
      const seatLabel = p.seatCode || 'Choose seat';
      const meta = p.seatCode ? `${p.cabin || 'Class'} ‚Ä¢ ${p.position || 'Seat type'}` : 'Awaiting selection';
      chip.innerHTML = `
        <div class="pax-label">${p.label}</div>
        <div class="pax-seat">${seatLabel}</div>
        <div class="pax-meta">${meta}</div>
      `;
      chip.addEventListener('click', ()=>{
        state.activePassenger = idx;
        refreshSeatClasses();
        updateTotals();
        renderPassengers();
        persistSelection();
      });
      passengerListEl.appendChild(chip);
    });
  }

  function persistSelection(){
    const payload = {
      flightId,
      pax: state.passengers.length,
      passengers: state.passengers,
      layout: state.layout,
      origin: state.origin,
      destination: state.destination,
      depart_time: state.depart_time,
      activePassenger: state.activePassenger,
      fingerprint: state.fingerprint
    };
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); }catch(e){}
  }

  function isSeatValid(code){
    const parsed = parseSeat(code);
    if(!parsed) return false;
    if(parsed.row < 1 || parsed.row > state.rows) return false;
    const inRow = groupsForRow(parsed.row).some(g=>g.includes(parsed.letter));
    if(!inRow) return false;
    return !(state.blocked.has(code) || state.occupied.has(code) || state.held.has(code));
  }

  function clearSaved(){
    try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
  }

  function loadSavedSelections(fingerprint){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    try{
      const saved = JSON.parse(raw);
      if(saved.fingerprint && fingerprint && saved.fingerprint !== fingerprint){
        clearSaved();
        return;
      }
      const savedPassengers = Array.isArray(saved.passengers) ? saved.passengers : [];
      const seenSeats = new Set();
      state.seatToPassenger = Object.create(null);
      savedPassengers.slice(0, state.passengers.length).forEach((p, idx)=>{
        if(!p.seatCode) return;
        if(!isSeatValid(p.seatCode)) return;
        if(seenSeats.has(p.seatCode)) return;
        state.passengers[idx] = { ...state.passengers[idx], ...p };
        state.seatToPassenger[p.seatCode] = idx;
        seenSeats.add(p.seatCode);
      });
      if(saved.activePassenger !== undefined){
        state.activePassenger = Math.min(state.passengers.length-1, saved.activePassenger || 0);
      }
    }catch(err){
      console.warn('Unable to read saved seats', err);
    }
  }

  function advancePassenger(){
    const next = state.passengers.findIndex((p, idx)=>!p.seatCode && idx!==state.activePassenger);
    if(next !== -1) state.activePassenger = next;
  }

  function onSeatClick(code, btn){
    const owner = state.seatToPassenger[code];
    if(owner !== undefined && owner !== state.activePassenger){
      state.activePassenger = owner;
      refreshSeatClasses(); renderPassengers(); updateTotals(); persistSelection();
      return;
    }
    const p = state.passengers[state.activePassenger];
    if(p.seatCode === code){
      delete state.seatToPassenger[code];
      p.seatCode=""; p.cabin=""; p.position=""; p.row=null; p.letter="";
      refreshSeatClasses(); renderPassengers(); updateTotals(); persistSelection();
      return;
    }

    if(p.seatCode){
      delete state.seatToPassenger[p.seatCode];
    }
    const details = seatDetails(code);
    p.seatCode = code; p.cabin = details.cabin; p.position = details.position; p.row = details.row; p.letter = details.letter;
    state.seatToPassenger[code] = state.activePassenger;

    refreshSeatClasses();
    advancePassenger();
    renderPassengers();
    updateTotals();
    persistSelection();
  }

  continueBtn.addEventListener('click', ()=>{
    persistSelection();
    const base = continueBtn.dataset.bookingUrl;
    const qs = new URLSearchParams({flight_id: flightId, pax: state.passengers.length});
    window.location.href = `${base}?${qs.toString()}`;
  });

  (async function init(){
    const res = await fetch(`/api/flights/${flightId}/seats`);
    if(!res.ok){ alert('Failed to load seats'); return; }
    const data = await res.json();
    state.origin = data.origin; state.destination = data.destination; state.depart_time = data.depart_time;
    state.layout = data.layout; state.rows = data.rows; state.classes = data.classes || [];
    state.prices = data.prices || {};
    state.occupied = new Set(data.occupied || []);
    state.held = new Set(data.held || []);
    state.blocked = new Set(data.blocked || []);
    state.exit_rows = data.exit_rows || [];
    state.fingerprint = `${flightId}|${state.depart_time}|pax:${state.pax}`;

    // reset storage if requested or if flight context/pax count changed
    const savedRaw = localStorage.getItem(STORAGE_KEY);
    if(resetParam){
      clearSaved();
    } else if(savedRaw){
      try{
        const saved = JSON.parse(savedRaw);
        const mismatch = !saved.fingerprint || saved.fingerprint !== state.fingerprint || saved.pax !== state.pax;
        if(mismatch){ clearSaved(); }
      }catch(e){ clearSaved(); }
    }

    state.seatToPassenger = Object.create(null);
    state.passengers = Array.from({length: state.pax}, (_,i)=>createPassenger(i));
    if(!resetParam){
      loadSavedSelections(state.fingerprint);
    }
    renderGrid();
    renderPassengers();
    refreshSeatClasses();
    updateTotals();
  })();
</script>
</body>
</html>
